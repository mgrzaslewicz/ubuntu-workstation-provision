---
- name: Install mise
  hosts: all
  gather_facts: False
  tags: mise
  tasks:
    - name: Get latest mise version from GitHub API
      uri:
        url: https://api.github.com/repos/jdx/mise/releases/latest
        method: GET
        return_content: yes
        status_code: 200
      register: github_release
      until: github_release.status == 200
      retries: 3
      delay: 5
      changed_when: false
    - name: Extract latest version tag
      set_fact:
        mise_latest_version: "{{ github_release.json.tag_name }}"
    - name: Check if mise is already installed
      shell: command -v mise || test -f ~/.local/bin/mise && echo ~/.local/bin/mise || echo "not found"
      register: mise_check
      changed_when: false
    - name: Get current mise version if installed
      shell: "{{ mise_check.stdout }} --version 2>/dev/null | grep -oE '[0-9]+\\.[0-9]+\\.[0-9]+' | head -1 | sed 's/^/v/' || echo 'not installed'"
      when: "'not found' not in mise_check.stdout"
      register: mise_current_version
      changed_when: false
      failed_when: false
    - name: Set current version to not installed if mise not found
      set_fact:
        mise_current_version: "{{ {'stdout': 'not installed'} }}"
      when: "'not found' in mise_check.stdout"
    - name: Normalize current version format
      set_fact:
        mise_current_version_normalized: "{{ mise_current_version.stdout | regex_replace('^v', '') | default('not installed') }}"
    - name: Normalize latest version format
      set_fact:
        mise_latest_version_normalized: "{{ mise_latest_version | regex_replace('^v', '') }}"
    - name: Display version comparison info
      debug:
        msg: "Current mise version: {{ mise_current_version.stdout }}, Latest version: {{ mise_latest_version }}, Will install: {{ mise_current_version_normalized != mise_latest_version_normalized }}"
      changed_when: false
    - name: Download mise install script for specific version
      get_url:
        url: "https://github.com/jdx/mise/releases/download/{{ mise_latest_version }}/install.sh"
        dest: /tmp/mise-install.sh
        mode: 0700
        timeout: 30
      register: download
      until: download is success
      retries: 3
      delay: 5
      changed_when: false
      when: mise_current_version_normalized != mise_latest_version_normalized
    - name: Install mise
      when: mise_current_version_normalized != mise_latest_version_normalized
      shell: bash /tmp/mise-install.sh
      changed_when: true
    - name: Find mise binary path
      shell: command -v mise || echo ~/.local/bin/mise
      register: mise_path
      changed_when: false
